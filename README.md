# Canvas Practice Quiz Grading Automation

This project automates grading for **Canvas practice quizzes**. Instead of manually opening "Moderate This Quiz" and the Gradebook in two tabs to enter 1/0 for each student, you run a script that uses the Canvas API to determine who attempted on time (1) vs. late or not attempted (0), then updates an exported gradebook CSV. You import that CSV back into Canvas to update grades in one go.

---

## Table of Contents

- [What This Does](#what-this-does)
- [Prerequisites](#prerequisites)
- [Canvas API Token: How to Get and Set It](#canvas-api-token-how-to-get-and-set-it)
- [Main Workflow: Update Grades for One Quiz](#main-workflow-update-grades-for-one-quiz)
- [Assignment Column Mapping](#assignment-column-mapping)
- [All Commands Reference](#all-commands-reference)
- [Grading Logic](#grading-logic)
- [Scripts Overview](#scripts-overview)
- [Excluding Files from GitHub](#excluding-files-from-github)

---

## What This Does

1. You **download the full gradebook** from Canvas (Grades → Actions → Export). This gives you a CSV with all students and all assignment columns.
2. You run **`update_gradebook_csv.py`** with the path to that CSV and the quiz ID. The script:
   - Fetches the quiz due date and all quiz submissions from the Canvas API.
   - Fetches course enrollments.
   - For each student: **on-time attempt → 1.00**, **late or not attempted → 0.00**.
   - Writes a **new CSV** that is identical to your export except the chosen quiz column is updated with these grades (the file is named like `YourExport-updated.csv`).
3. You **upload the generated CSV** to Canvas (Grades → Actions → Import). Canvas updates only the assignment column you changed; read-only columns (percentages, final grades) are ignored and recalculated automatically.

---

## Prerequisites

- **Python 3** (e.g. 3.8+).
- **`requests`** library: `pip install requests`.
- A **Canvas API token** (see below).
- Optional: a virtual environment (e.g. `python -m venv .venvcanva` then `pip install requests`).

---

## Canvas API Token: How to Get and Set It

### How to get a Canvas API token

1. Log in to your Canvas instance (e.g. `https://canvas.asu.edu`).
2. Click your **profile/account** (e.g. avatar or "Account" in the left sidebar).
3. Go to **Settings** (**Approved Integrations**).
4. Find **"New Access Token"**.
5. Create a new token: give it a purpose (e.g. "Quiz grading script"), set an expiry if required, and generate.
6. **Copy the token once** — it is shown only at creation. Store it somewhere safe. You will use it as an environment variable.

### How to set the token in the environment

The scripts read the token from the environment variable **`CANVAS_API_TOKEN`**. Set it **before** running any script that calls the API.

**Windows (Command Prompt):**
```cmd
set CANVAS_API_TOKEN=paste_your_token_here
```

**macOS / Linux:**
```bash
export CANVAS_API_TOKEN="paste_your_token_here"
```

---

## Main Workflow: Update Grades for One Quiz

Follow these steps whenever you want to fill grades for one practice quiz (1 = on time, 0 = late or not attempted).

### Step 1: Set your API token

In the terminal you will use:

```bash
export CANVAS_API_TOKEN="paste_your_token_here"
```

### Step 2: Download the full gradebook from Canvas

1. In Canvas, open your course.
2. Go to **Grades**.
3. Use **Actions** (or the menu) → **Export** to download the gradebook.
4. Save the CSV file (e.g. to your project folder). Note the full path — you will pass it to the script.

### Step 3: Run the update script

From your project directory (and with your venv activated if you use one):

```bash
python -u update_gradebook_csv.py "path/to/your/exported-grades.csv" --quiz-id QUIZ_ID
```

- Replace **`path/to/your/exported-grades.csv`** with the actual path to the CSV you downloaded (use forward slashes or the format your shell expects; see note below if you get a continuation prompt `>`).
- Replace **`QUIZ_ID`** with the Canvas quiz ID (e.g. `1944830`). You can get quiz IDs from the quiz URL in Canvas or by running `build_quiz_metadata_index.py` (see [Assignment Column Mapping](#assignment-column-mapping)).

**Example :**
```bash
python -u update_gradebook_csv.py "D:/CanvasAutomateQuiz/2026-02-12T1107_Grades-2026SpringC-T-CSE412-38851.csv" --quiz-id 1944830
```

The script writes a new file next to your export, with **`-updated`** before `.csv` (e.g. `2026-02-12T1107_Grades-...-updated.csv`). **This generated CSV is the file you will upload to Canvas in the next step.**


### Step 4: Upload the generated CSV to Canvas

1. In Canvas, open **Grades** for the same course.
2. Use **Actions** → **Import**.
3. Select the **`-updated.csv`** file produced in Step 3 (the one generated by `update_gradebook_csv.py`).
4. Complete the import. Canvas will update only the assignment (quiz) column; read-only columns (Current Score, Final Grade, etc.) are ignored and recalculated.

---

## Assignment Column Mapping

The update script needs the **exact gradebook column name** for the quiz (e.g. `SQL: JOIN, AGGREGATION, HAVING, NESTED QUERIES (7198613)`). It is resolved in this order:

1. **Quiz metadata from API:** If you run `build_quiz_metadata_index.py`, it fetches quizzes and their linked assignments and stores `gradebook_column` in `cse412_quiz_metadata.json`. For those quizzes, no manual mapping is needed.
2. **Manual mapping file:** `quiz_gradebook_columns.json` maps `course_id` → `quiz_id` → exact column name. Add an entry for any quiz whose column name is not in the metadata (e.g. new quizzes). You can append new quiz IDs; existing entries stay.
3. **Command line:** You can pass `--assignment-column "Exact Name (assignment_id)"` to force the column.

The column name in the export always includes the assignment ID in parentheses (e.g. `... (7198613)`). You can get this from the exported CSV header or by running the mapping helper (see below).

### Optional: Suggest column name from an export

To get a suggested quiz_id → column name (e.g. for a new quiz), run:

```bash
python build_gradebook_mapping.py "path/to/your/exported-grades.csv" --course-id YOUR_COURSE_ID
```

Review the output and add or correct the suggested column name in `quiz_gradebook_columns.json` (use the exact string from the CSV, including the number in parentheses).

---

## All Commands Reference

| Step | Command | Description |
|------|---------|-------------|
| Set token (PowerShell) | `$env:CANVAS_API_TOKEN = "your_token"` | Set API token for the current session. |
| Set token (Git Bash) | `export CANVAS_API_TOKEN="your_token"` | Same, for Git Bash / MINGW64. |
| Refresh quiz/assignment metadata | `python build_quiz_metadata_index.py` | Fetches quizzes and gradebook columns from API; updates `cse412_quiz_metadata.json`. Run when you add new quizzes. |
| Suggest column from CSV | `python build_gradebook_mapping.py "path/to/exported.csv" --course-id 249800` | Prints suggested quiz_id → column name; use to fill `quiz_gradebook_columns.json`. |
| **Update gradebook CSV** | `python -u update_gradebook_csv.py "path/to/exported-grades.csv" --quiz-id QUIZ_ID` | Reads export, fills 1/0 for the given quiz, writes `-updated.csv`. Upload that file to Canvas. |
| Override column name | `python -u update_gradebook_csv.py "path/to/exported.csv" --quiz-id QUIZ_ID --assignment-column "Exact Name (id)"` | Same as above but forces the assignment column (no lookup in metadata or JSON). |
| Custom output path | `python -u update_gradebook_csv.py "path/to/exported.csv" --quiz-id QUIZ_ID --out "path/to/output.csv"` | Writes the updated CSV to the specified path. |
| Different course | `python -u update_gradebook_csv.py "path/to/exported.csv" --quiz-id QUIZ_ID --course-id 249800` | Use when your course ID is not the default. |


---

## Grading Logic

- **On-time attempt** (submitted by the quiz due date): grade **1.00**.
- **Late attempt** (submitted after the due date): grade **0.00**.
- **Not attempted**: grade **0.00**.
- **In-progress / no `finished_at`**: treated as **0.00**.

---

## Scripts Overview

| Script | Purpose |
|--------|---------|
| **update_gradebook_csv.py** | Main script: reads exported gradebook CSV, fetches quiz due date and submissions from API, computes 1/0 per student, writes updated CSV for import. |
| **build_quiz_metadata_index.py** | Fetches all quizzes and their gradebook assignments from the Canvas API; writes `cse412_quiz_metadata.json` with `assignment_id`, `assignment_name`, `gradebook_column`. Run when you add new quizzes. |
| **build_gradebook_mapping.py** | Reads an exported CSV and suggests quiz_id → gradebook column name; helps fill `quiz_gradebook_columns.json` for new quizzes. |
| **generate_attempt_report.py** | Fetches quiz submissions and enrollments; writes `quiz_on_time.txt`, `quiz_late.txt`, `quiz_not_attempted.txt`. Uses `CANVAS_API_TOKEN`, optional `CANVAS_COURSE_ID`, `CANVAS_QUIZ_ID`. |
| **fetch_quiz_metadata.py** | Helper module: fetch quiz due date and quiz–assignment mapping. |
| **fetch_enrollments.py** | Helper module: fetch course enrollments. |
| **canvas_paginated_fetch.py** | Helper module: paginated API requests (e.g. quiz submissions). |

### Verification: list students who attempted, did not attempt, or submitted late

If you want to **verify** the results (e.g. double-check who got 1 vs 0 before or after importing the CSV), you can run **`generate_attempt_report.py`**. It uses the same logic as the gradebook update script and writes three text files:

- **`quiz_on_time.txt`** — Student names (and login ID, score) who submitted on time.
- **`quiz_late.txt`** — Student names who submitted after the due date.
- **`quiz_not_attempted.txt`** — Student names who did not attempt the quiz.

Set the quiz (and optionally course) via environment variables, then run:

```bash
export CANVAS_API_TOKEN="your_token"
export CANVAS_QUIZ_ID=1944830
export CANVAS_COURSE_ID=249800
python generate_attempt_report.py
```

 The script writes the three `.txt` files in the current directory. This is optional and for verification only; it does not change the gradebook.

---